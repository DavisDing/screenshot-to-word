

# 📘 软件设计文档：SCREENSHOT-TO-WORD

---

## 一、项目概述

### 1.1 项目名称
SCREENSHOT-TO-WORD

### 1.2 项目目标
构建一个支持截图标注与文档生成的桌面自动化工具，面向测试人员，简化“测试用例 → 手工截图 → Word 记录 → 执行结果更新”流程，提高手工测试效率和文档一致性。

### 1.3 核心功能

- Excel 用例读取（支持基础版、步骤版）
- 控制面板展示验证点、步骤等信息
- 快捷键启动截图、标注
- 标注支持画圈、文字、撤销
- 自动保存截图并按规则命名
- 自动插入 Word 报告
- Excel 状态自动标记为“已执行”

---

## 二、系统架构设计

### 2.1 总体结构图

```
main.py
 └── core/
     ├── test_runner.py      → 控制用例流程、处理截图调度
     └── screenshot.py       → 管理截图、标注界面调用
 └── ui/
     ├── control_panel.py    → 控制面板 UI
     └── annotator.py        → 标注 UI（画圈、写字、撤销）
 └── utils/
     ├── excel_handler.py    → Excel 读写
     ├── word_generator.py   → Word 插图、段落生成
     ├── logger.py           → 日志管理
     └── path_utils.py       → 路径处理
```

---

### 2.2 技术栈

| 模块         | 技术                     |
|--------------|--------------------------|
| UI界面       | Tkinter                  |
| 快捷键捕捉   | `keyboard` + `pyautogui` |
| Excel 处理   | `pandas` + `openpyxl`    |
| Word 生成    | `python-docx`            |
| 图像处理     | `Pillow`                 |
| 打包发布     | `pyinstaller`            |

---

## 三、模块说明（含调用逻辑）

### 3.1 `main.py`
- 启动入口，初始化 UI 和主线程
- 加载 Excel 文件路径
- 调用 `TestRunner.run()` 启动测试任务

---

### 3.2 `test_runner.py`（核心控制器）

- 读取用例（支持基础/步骤版识别）
- 控制用例逐条执行，逐步截图
- 控制标注窗口显示/关闭
- 更新 Word 文件
- 标记 Excel 行状态为“已执行”

示例流程：
```python
def run_test_case(case_info):
    display_to_control_panel(case_info)
    wait_for_user_screenshot()
    save_screenshot()
    insert_to_word()
    update_excel_status()
```

---

### 3.3 `screenshot.py`

- 截取全屏或指定区域
- 启动 `annotator.py` 弹出画布标注
- 保存标注图片到命名目录

---

### 3.4 `annotator.py`

- 提供画图画布（Canvas）
- 用户可画圈、写字、撤销
- 标注完成后输出图像至文件

---

### 3.5 `control_panel.py`

- 基于 Tkinter 显示 UI 信息：
  - 当前验证点
  - 当前步骤名称、步骤描述（步骤模式时）
- 提供“截图”、“下一步”、“完成”、“退出”等按钮

---

### 3.6 `excel_handler.py`

- 自动识别表格格式（判断列数）
- 读取用例为 `DataFrame`
- 按条件筛选待执行用例
- 写回“执行结果”列

---

### 3.7 `word_generator.py`

- 查找或新建对应 Word 文件
- 插入段落信息（验证点、步骤描述）
- 插入截图（带编号）
- 控制截图与文字格式样式（字体、对齐）

---

### 3.8 `logger.py`

- 控制日志级别（INFO / ERROR）
- 输出到 logs/output.log

---

### 3.9 `path_utils.py`

- 规范化保存路径
- 按用例名自动创建图片目录
- 图片命名如：`1.png`、`2.png`...

---

## 四、用例格式设计

### 4.1 基础版（3 列）

| 用例名 | 验证点         | 执行结果   |
|--------|----------------|------------|
| 登录   | 输入框显示正确 | 空白 / 已执行 |

逻辑流程：
- 显示验证点 → 截图标注 → 插图到 Word → 标记“已执行”

---

### 4.2 步骤版（6 列）

| 测试名称 | 验证点 | 步骤名称 | 步骤描述 | 预期结果 | 测试结果 |
|----------|--------|----------|----------|----------|----------|

逻辑流程：
- 每一步单独截图标注
- 控制面板显示步骤信息
- 步骤全部完成后才允许完成整个用例

---

## 五、用户交互流程图

```text
启动程序
   ↓
读取 Excel 文件
   ↓
判断是否为步骤版
   ↓
显示第一条验证点/步骤
   ↓
用户按快捷键截图（或点击按钮）
   ↓
弹出标注窗口
   ↓
标注完成 → 保存截图
   ↓
插入 Word 文件
   ↓
更新 Excel 状态
   ↓
是否还有下一条？
   └→ 是 → 继续下一条
   └→ 否 → 结束
```

---

## 六、异常与容错设计

| 场景                       | 处理方式                          |
|----------------------------|-----------------------------------|
| Excel/Word 文件占用         | 捕获异常后弹窗提示重新尝试        |
| 用户中断操作（ESC）         | 当前步骤保留标注，自动跳转下一步  |
| Word 文件不存在             | 自动新建文件                      |
| 文件命名重复（截图）        | 自动编号（如 `截图_1.png`）      |
| 非法路径或格式不符          | 日志记录并跳过                    |

---

## 七、后续可拓展内容（建议）

- 增加截图模板（如固定大小区域）
- 插图前图片自动压缩
- 支持标注图片批量导出为 PDF
- 可配置用例执行顺序或筛选条件
- 加入版本控制、报告上传、自动归档功能
- 支持多语言切换（UI 本地化）

---


## 八、依赖模块（requirements.txt）

```text
pandas
openpyxl
python-docx
pyautogui
keyboard
Pillow
tk
```

---

## 九、CI/CD 与自动发布说明

- 使用 GitHub Actions 进行自动打包、自动打 tag 和发布 release
- 为兼容 Windows runner，所有 shell 脚本改写为 PowerShell（`shell: pwsh`）
- 避免使用 `$(...)` 和 `` `command` `` 等 bash 特有语法，统一使用 `$var = xxx` 写法
- 所有 Release 操作由 `gh release create` 命令完成，无需依赖第三方 action
- 示例见 `.github/workflows/build.yml`

---

## 🔒 AI 协助开发注意事项

为避免 AI 自动生成代码重复引入历史错误，建议在 AI 提示词中加入以下约束要求：

- ✅ 请确保脚本兼容 Windows 平台，禁止使用 Bash 特有语法，推荐使用 PowerShell（如 GitHub Actions）
- ✅ 判断 Excel 格式需基于列数及字段名称，严禁硬编码
- ✅ 步骤执行需具备完整性校验逻辑，控制“完成”按钮只能在所有步骤完成后启用
- ✅ 所有文件操作应捕获文件占用异常，避免程序崩溃，可提示用户“请关闭文件后重试”
- ✅ 快捷键监听必须运行在 UI 主线程，建议使用 `keyboard` 监听并在窗口活跃状态下启用
- ✅ Word 文件不存在时应自动新建，已有时应支持追加而非覆盖
- ✅ 对于已执行用例，应避免重复截图与插图，应有执行状态标记（如“已执行”）

---

## ✅ 历史问题总结与设计防呆说明

| 问题 | 对应防范设计 |
|------|--------------|
| 无法区分基础版和步骤版 Excel | 基于列数与字段名判断，格式异常自动跳过 |
| 快捷键 F8 无响应 | 控制 UI 主线程监听，确保窗口激活，建议管理员权限 |
| Word 被占用导致插图失败 | 文件写入异常捕获，提示关闭 Word 后重试 |
| 步骤未完成就点击“完成” | 所有步骤截图状态记录，完成按钮仅在全部完成后解锁 |
| GitHub Action 在 Windows 下失败 | 所有 CI 脚本改为 PowerShell (`shell: pwsh`) |
| Word 不存在时报错 | 插图前自动创建 Word 文件 |
| 截图命名冲突被覆盖 | 使用顺序编号命名：`截图_1.png`、`截图_2.png` 等 |